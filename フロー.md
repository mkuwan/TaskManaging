# 業務スケジュール管理システム - 処理フロー

## 概要

このドキュメントでは、業務スケジュール管理システムの処理フローを図解しています。このシステムは、カレンダーと業務一覧のデータを元に、指定日付に実行すべき業務スケジュールを自動生成します。

### システムの目的
このシステムは、日次・週次・月次・年次で発生する様々な業務の実行スケジュールを自動的に生成することで、業務の漏れや遅延を防止し、計画的な業務実行をサポートします。

### 処理の大まかな流れ
1. **データ読み込み**：カレンダー.csvから営業日情報、業務一覧テーブルから業務定義情報を読み込みます
2. **日付判定**：特定の日付が「対象日」となるかを各業務ごとに判定します
3. **条件判定**：業務の周期（日次/週次/月次/年次）と基準（暦日/営業日）に応じたルールで実行対象かを判定します
4. **振替処理**：非営業日の場合、振替規則（直前営業日/直後営業日/振替しない）に従って処理します
5. **スケジュール生成**：判定結果を業務スケジュールテーブルとして出力します

### 詳細な判定ロジック

**1. 日次業務の場合**
- 暦日指定：毎日実行
- 営業日指定：営業日フラグが立っている日のみ実行

**2. 週次業務の場合**
- 暦日(曜日)指定：特定の曜日（月曜、火曜など）に実行

**3. 月次業務の場合**
- 暦日(n日指定)：毎月n日に実行（例：毎月15日）
- 暦日(月末逆算)：月末からn日前に実行（例：月末3日前、n=0なら月末日）
- 営業日(n日指定)：月のn番目の営業日に実行（例：第3営業日）
- 営業日(月末逆算)：月末からn番目の営業日に実行（例：月末から2営業日前）
- 暦日(曜日)：第n週の特定曜日に実行（例：第2月曜日）

**4. 年次業務の場合**
- 特定の月を指定＋月次業務と同様の条件（例：4月の第1営業日）

**5. 非営業日振替処理**
- 直前営業日：非営業日の場合、直前の営業日に振り替える
- 直後営業日：非営業日の場合、直後の営業日に振り替える
- 振替しない：非営業日でも日付を変更しない（実行対象とする）

このシステムでは常に「営業日」の概念が重要になります。営業日はカレンダー.csvで定義され、土日祝日などは通常「非営業日」として扱われます。業務の定義によっては、非営業日に当たる業務を前後の営業日に振り替えることができます。

以下の図表では、これらの処理フローを視覚的に表現し、詳細な判定ロジックを示しています。

## 1. 全体システム構成

```mermaid
flowchart TB
    subgraph "データソース"
        カレンダーCSV[カレンダー.csv]
        業務一覧テーブル[業務一覧テーブル.csv]
    end
    
    subgraph "処理・判定エンジン"
        日次処理[日次処理]
        週次処理[週次処理]
        月次処理[月次処理]
        年次処理[年次処理]
        営業日判定[営業日判定]
        非営業日振替処理[非営業日振替処理]
    end
    
    subgraph "出力"
        業務スケジュール[業務スケジュールテーブル]
        PowerBIレポート[PowerBIレポート・ダッシュボード]
    end
    
    カレンダーCSV --> 営業日判定
    業務一覧テーブル --> 日次処理
    業務一覧テーブル --> 週次処理
    業務一覧テーブル --> 月次処理
    業務一覧テーブル --> 年次処理
    営業日判定 --> 日次処理
    営業日判定 --> 週次処理
    営業日判定 --> 月次処理
    営業日判定 --> 年次処理
    営業日判定 --> 非営業日振替処理
    日次処理 --> 非営業日振替処理
    週次処理 --> 非営業日振替処理
    月次処理 --> 非営業日振替処理
    年次処理 --> 非営業日振替処理
    非営業日振替処理 --> 業務スケジュール
    業務スケジュール --> PowerBIレポート
```

## 2. メイン処理フロー

```mermaid
flowchart TB
    開始 --> 対象日確定[対象日の確定]
    対象日確定 --> カレンダー読込[カレンダー情報読込]
    カレンダー読込 --> 業務一覧読込[業務一覧テーブル読込]
    業務一覧読込 --> 有効業務フィルタ[有効期間内業務フィルタ]

    subgraph "周期別判定処理"
        有効業務フィルタ --> 周期分岐{周期・頻度による分岐}
        周期分岐 -->|日次| 日次判定[日次業務判定]
        周期分岐 -->|週次| 週次判定[週次業務判定]
        周期分岐 -->|月次| 月次判定[月次業務判定]
        周期分岐 -->|年次| 年次判定[年次業務判定]
    end

    日次判定 --> 振替判定{非営業日振替必要?}
    週次判定 --> 振替判定
    月次判定 --> 振替判定
    年次判定 --> 振替判定

    振替判定 -->|YES| 振替処理[非営業日振替処理]
    振替判定 -->|NO| スケジュール作成[業務スケジュール作成]
    振替処理 --> スケジュール作成
    スケジュール作成 --> スケジュール保存[業務スケジュールテーブル保存]
    スケジュール保存 --> 終了
```

## 3. 日次業務判定フロー

```mermaid
flowchart TB
    日次開始[日次業務判定開始] --> 基準分岐{基準}
    基準分岐 -->|営業日| 営業日判定{対象日は営業日?}
    営業日判定 -->|YES| 日次実行[実行対象と判定]
    営業日判定 -->|NO| 日次実行対象外[実行対象外と判定]
    基準分岐 -->|暦日| 日次実行[実行対象と判定]
    日次実行 --> 日次終了[日次業務判定終了]
    日次実行対象外 --> 日次終了
```

## 4. 週次業務判定フロー

```mermaid
flowchart TB
    週次開始[週次業務判定開始] --> 基準分岐{基準}
    基準分岐 -->|"暦日(曜日)"| 曜日判定{設定曜日と一致?}
    曜日判定 -->|YES| 週次実行[実行対象と判定]
    曜日判定 -->|NO| 週次実行対象外[実行対象外と判定]
    週次実行 --> 週次終了[週次業務判定終了]
    週次実行対象外 --> 週次終了
```

## 5. 月次業務判定フロー

```mermaid
flowchart TB
    月次開始[月次業務判定開始] --> 基準分岐{基準}

    基準分岐 -->|"暦日(n日指定)"| 日付判定{n日と一致?}
    日付判定 -->|YES| 月次実行[実行対象と判定]
    日付判定 -->|NO| 月次実行対象外[実行対象外と判定]

    基準分岐 -->|"暦日(月末逆算)"| 月末逆算判定{月末からn日前と一致?}
    月末逆算判定 -->|YES| 月次実行
    月末逆算判定 -->|NO| 月次実行対象外

    基準分岐 -->|"営業日(n日指定)"| 営業日判定{n番目の営業日と一致?}
    営業日判定 -->|YES| 月次実行
    営業日判定 -->|NO| 月次実行対象外

    基準分岐 -->|"営業日(月末逆算)"| 営業日月末逆算判定{月末からn営業日前と一致?}
    営業日月末逆算判定 -->|YES| 月次実行
    営業日月末逆算判定 -->|NO| 月次実行対象外

    基準分岐 -->|"暦日(曜日)"| 週番号曜日判定{第n週の指定曜日と一致?}
    週番号曜日判定 -->|YES| 月次実行
    週番号曜日判定 -->|NO| 月次実行対象外

    月次実行 --> 月次終了[月次業務判定終了]
    月次実行対象外 --> 月次終了
```

## 6. 年次業務判定フロー

```mermaid
flowchart TB
    年次開始[年次業務判定開始] --> 月判定{設定月と一致?}
    月判定 -->|YES| 基準分岐{基準}
    月判定 -->|NO| 年次実行対象外[実行対象外と判定]

    基準分岐 -->|"暦日(n日指定)"| 日付判定{n日と一致?}
    日付判定 -->|YES| 年次実行[実行対象と判定]
    日付判定 -->|NO| 年次実行対象外

    基準分岐 -->|"暦日(月末逆算)"| 月末逆算判定{月末からn日前と一致?}
    月末逆算判定 -->|YES| 年次実行
    月末逆算判定 -->|NO| 年次実行対象外

    基準分岐 -->|"営業日(n日指定)"| 営業日判定{n番目の営業日と一致?}
    営業日判定 -->|YES| 年次実行
    営業日判定 -->|NO| 年次実行対象外

    基準分岐 -->|"営業日(月末逆算)"| 営業日月末逆算判定{月末からn営業日前と一致?}
    営業日月末逆算判定 -->|YES| 年次実行
    営業日月末逆算判定 -->|NO| 年次実行対象外

    基準分岐 -->|"暦日(曜日)"| 週番号曜日判定{当月の第n週の指定曜日と一致?}
    週番号曜日判定 -->|YES| 年次実行
    週番号曜日判定 -->|NO| 年次実行対象外

    年次実行 --> 年次終了[年次業務判定終了]
    年次実行対象外 --> 年次終了
```

## 7. 非営業日振替処理フロー（更新版）

```mermaid
flowchart TB
    振替開始[非営業日振替処理開始] --> 振替状況確認{入力日付が他日からの振替先か?}
    振替状況確認 -->|YES| 振替済判定[すでに振替済みと判断]
    振替状況確認 -->|NO| 営業日判定{対象日は営業日?}
    
    営業日判定 -->|YES| 振替不要[振替不要]
    営業日判定 -->|NO| 振替規則確認{振替規則}
    
    振替規則確認 -->|直前営業日| 直前営業日取得[直前営業日を取得]
    振替規則確認 -->|直後営業日| 直後営業日取得[直後営業日を取得]
    振替規則確認 -->|振替しない| 振替不要
    
    直前営業日取得 --> 日付更新[業務日を振替日に更新]
    直後営業日取得 --> 日付更新
    
    日付更新 --> 振替完了[振替処理完了]
    振替不要 --> 振替完了
    振替済判定 --> 振替完了
```

## 7-1. 振替対象日の判定プロセス

```mermaid
flowchart TB
    判定開始[振替対象日判定開始] --> 営業日判定{対象日は営業日?}
    営業日判定 -->|YES| 振替先判定{振替元となる非営業日を探索}
    営業日判定 -->|NO| 二重判定[本来の日付のまま処理]
    
    振替先判定 --> 直前振替確認{直前営業日として対応する非営業日あり?}
    直前振替確認 -->|YES| 振替先と特定[振替先の日付と特定]
    直前振替確認 -->|NO| 直後振替確認{直後営業日として対応する非営業日あり?}
    
    直後振替確認 -->|YES| 振替先と特定
    直後振替確認 -->|NO| 通常処理[通常日として処理]
    
    振替先と特定 --> 判定終了[判定終了]
    通常処理 --> 判定終了
    二重判定 --> 判定終了
```

## 9. 「n日」カラムの使用方法詳細

```mermaid
flowchart LR
    nDay[n日カラム] --> 基準分岐{基準}
    
    基準分岐 -->|"暦日(n日指定)"| 暦日日指定["n日 = 1~31（カレンダー上の日付）"]
    基準分岐 -->|"営業日(n日指定)"| 営業日日指定["n日 = 1~31（当月n番目の営業日）"]
    
    基準分岐 -->|"暦日(月末逆算)"| 暦日月末指定["n日 = 0（末日）, 1（末日から1日前）, ..."]
    基準分岐 -->|"営業日(月末逆算)"| 営業日月末指定["n日 = 0（最終営業日）, 1（最終営業日から1営業日前）, ..."]
```

## 10. データフロー詳細

```mermaid
flowchart TB
    subgraph "入力データ"
        カレンダー["カレンダー.csv
        - 年月日
        - 営業日フラグ
        - 曜日
        - 営業日（当月n日目）
        - 逆算営業日（当月末からn日目）"]
        
        業務一覧["業務一覧テーブル.csv
        - 業務ID
        - 業務名
        - 周期・頻度 (日次/週次/月次/年次)
        - 基準 (暦日/営業日)
        - 月/週番号/曜日/n日
        - 非営業日振替規則
        - 有効期間"]
    end
    
    subgraph "処理"
        読込処理["1. データ読込処理"]
        有効判定["2. 有効期間判定"]
        該当日判定["3. 該当日判定
        - 日次: 毎日/営業日
        - 週次: 曜日一致
        - 月次: 日付/週番号+曜日/営業日カウント
        - 年次: 月+条件一致"]
        振替処理["4. 非営業日振替処理
        - 直前営業日
        - 直後営業日
        - 振替しない"]
    end
    
    subgraph "出力データ"
        スケジュール["業務スケジュールテーブル
        - スケジュールID
        - 業務ID
        - 予定日"]
    end
    
    カレンダー --> 読込処理
    業務一覧 --> 読込処理
    
    読込処理 --> 有効判定
    有効判定 --> 該当日判定
    該当日判定 --> 振替処理
    振替処理 --> スケジュール
```

## 11. 全体条件判定一覧

以下は、システム内での条件判定の全体図です。

```mermaid
flowchart TB
    条件分岐{周期・頻度と基準}

    条件分岐 -->|"日次 + 暦日"| 毎日実行["毎日実行"]
    条件分岐 -->|"日次 + 営業日"| 営業日のみ実行["営業日のみ実行"]
    
    条件分岐 -->|"週次 + 暦日(曜日)"| 特定曜日実行["特定曜日に実行"]

    条件分岐 -->|"月次 + 暦日(n日指定)"| 毎月n日実行["毎月n日に実行"]
    条件分岐 -->|"月次 + 暦日(月末逆算)"| 月末からn日前実行["月末からn日前に実行"]
    条件分岐 -->|"月次 + 営業日(n日指定)"| 毎月n営業日目実行["毎月n営業日目に実行"]
    条件分岐 -->|"月次 + 営業日(月末逆算)"| 月末からn営業日前実行["月末からn営業日前に実行"]
    条件分岐 -->|"月次 + 暦日(曜日)"| 毎月第n週X曜日実行["毎月第n週X曜日に実行"]

    条件分岐 -->|"年次 + 暦日(n日指定)"| 特定月n日実行["特定月のn日に実行"]
    条件分岐 -->|"年次 + 暦日(月末逆算)"| 特定月末からn日前実行["特定月末からn日前に実行"]
    条件分岐 -->|"年次 + 営業日(n日指定)"| 特定月n営業日目実行["特定月のn営業日目に実行"]
    条件分岐 -->|"年次 + 営業日(月末逆算)"| 特定月末からn営業日前実行["特定月末からn営業日前に実行"]
    条件分岐 -->|"年次 + 暦日(曜日)"| 特定月第n週X曜日実行["特定月の第n週X曜日に実行"]
```

## 12. エラーハンドリングと例外処理

```mermaid
flowchart TB
    開始 --> トライ[try処理開始]
    トライ --> 条件チェック{条件チェック}
    条件チェック -->|OK| 正常処理[正常処理]
    条件チェック -->|NG| エラー検出[エラー検出]
    
    subgraph "エラー処理"
        エラー検出 --> エラー分類{エラーの種類}
        エラー分類 -->|日付不正| 日付エラー処理[日付エラー処理]
        エラー分類 -->|カレンダーデータ不足| カレンダーエラー処理[カレンダーデータ不足エラー処理]
        エラー分類 -->|条件不正| 条件エラー処理[条件エラー処理]
        エラー分類 -->|その他| その他エラー処理[その他エラー処理]
        
        日付エラー処理 --> ログ出力[エラーログ出力]
        カレンダーエラー処理 --> ログ出力
        条件エラー処理 --> ログ出力
        その他エラー処理 --> ログ出力
        
        ログ出力 --> エラー通知[エラー通知]
    end
    
    正常処理 --> 完了
    エラー通知 --> 完了
    完了 --> 終了
```

## 13. Power BIデータフロー

```mermaid
flowchart TB
    subgraph "データソース"
        業務一覧["業務一覧テーブル"]
        業務スケジュール["業務スケジュールテーブル"]
        カレンダー["カレンダーテーブル"]
    end
    
    subgraph "Power Query変換"
        業務マージ["業務+スケジュールマージ"]
        日付マージ["日付情報マージ"]
        メトリクス計算["遅延・進捗メトリクス計算"]
    end
    
    subgraph "Power BIモデル"
        進捗テーブル["進捗管理テーブル"]
        日付テーブル["日付ディメンション"]
        業務テーブル["業務ディメンション"]
        メジャー["DAXメジャー(KPI)"]
    end
    
    subgraph "Power BIビジュアル"
        ガントチャート["ガントチャート"]
        ダッシュボード["ダッシュボード"]
        進捗表["進捗管理表"]
        カレンダービュー["カレンダービュー"]
    end
    
    業務一覧 --> 業務マージ
    業務スケジュール --> 業務マージ
    カレンダー --> 日付マージ
    
    業務マージ --> 日付マージ
    日付マージ --> メトリクス計算
    
    メトリクス計算 --> 進捗テーブル
    メトリクス計算 --> 日付テーブル
    メトリクス計算 --> 業務テーブル
    
    進捗テーブル --> メジャー
    日付テーブル --> メジャー
    業務テーブル --> メジャー
    
    メジャー --> ガントチャート
    メジャー --> ダッシュボード
    メジャー --> 進捗表
    メジャー --> カレンダービュー
```