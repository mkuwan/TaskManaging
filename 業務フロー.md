# 業務スケジュール管理システム - 処理フロー

## 概要

このドキュメントでは、Office Scripts for Excel用の業務スケジュール管理システム（scheduler.osts）の処理フローを図解しています。このシステムは、カレンダーと業務一覧のデータを元に、指定日付に実行すべき業務スケジュールを自動生成します。

### システムの目的
このシステムは、日次・週次・月次・年次で発生する様々な業務の実行スケジュールを自動的に生成することで、業務の漏れや遅延を防止し、計画的な業務実行をサポートします。

### 処理の大まかな流れ
1. **データ読み込み**：カレンダー.csvから営業日情報、業務一覧テーブルから業務定義情報を読み込みます
2. **日付判定**：特定の日付が「対象日」となるかを各業務ごとに判定します
3. **条件判定**：業務の周期（日次/週次/月次/年次）と基準（暦日/営業日）に応じたルールで実行対象かを判定します
4. **振替処理**：非営業日の場合、振替規則（直前営業日/直後営業日/振替しない）に従って処理します
5. **スケジュール生成**：判定結果を業務スケジュールテーブルとして出力します

### 詳細な判定ロジック

**1. 日次業務の場合**
- 暦日指定：毎日実行
- 営業日指定：営業日フラグが立っている日のみ実行

**2. 週次業務の場合**
- 暦日(曜日)指定：特定の曜日（月曜、火曜など）に実行

**3. 月次業務の場合**
- 暦日(n日指定)：毎月n日に実行（例：毎月15日）
- 暦日(月末逆算)：月末からn日前に実行（例：月末3日前、n=0なら月末日）
- 営業日(n日指定)：月のn番目の営業日に実行（例：第3営業日）
- 営業日(月末逆算)：月末からn番目の営業日に実行（例：月末から2営業日前）
- 暦日(曜日)：第n週の特定曜日に実行（例：第2月曜日）

**4. 年次業務の場合**
- 特定の月を指定＋月次業務と同様の条件（例：4月の第1営業日）

**5. 非営業日振替処理**
- 直前営業日：非営業日の場合、直前の営業日に振り替える
- 直後営業日：非営業日の場合、直後の営業日に振り替える
- 振替しない：非営業日でも日付を変更しない（実行対象とする）

このシステムでは常に「営業日」の概念が重要になります。営業日はカレンダー.csvで定義され、土日祝日などは通常「非営業日」として扱われます。業務の定義によっては、非営業日に当たる業務を前後の営業日に振り替えることができます。

以下の図表では、これらの処理フローを視覚的に表現し、詳細な判定ロジックを示しています。

## 1. 全体システム構成

```mermaid
flowchart TB
    subgraph "データソース"
        カレンダーCSV[カレンダー.csv]
        業務一覧テーブル[業務一覧テーブル.csv]
    end
    
    subgraph "処理・判定エンジン"
        日次処理[日次処理]
        週次処理[週次処理]
        月次処理[月次処理]
        年次処理[年次処理]
        営業日判定[営業日判定]
        非営業日振替処理[非営業日振替処理]
    end
    
    subgraph "出力"
        業務スケジュール[業務スケジュールテーブル]
        PowerBIレポート[PowerBIレポート・ダッシュボード]
    end
    
    カレンダーCSV --> 営業日判定
    業務一覧テーブル --> 日次処理
    業務一覧テーブル --> 週次処理
    業務一覧テーブル --> 月次処理
    業務一覧テーブル --> 年次処理
    営業日判定 --> 日次処理
    営業日判定 --> 週次処理
    営業日判定 --> 月次処理
    営業日判定 --> 年次処理
    営業日判定 --> 非営業日振替処理
    日次処理 --> 非営業日振替処理
    週次処理 --> 非営業日振替処理
    月次処理 --> 非営業日振替処理
    年次処理 --> 非営業日振替処理
    非営業日振替処理 --> 業務スケジュール
    業務スケジュール --> PowerBIレポート
```

## 2. データフロー概要

```mermaid
flowchart TD
    subgraph InputData[入力データ]
        Calendar[カレンダーシート]
        TaskList[業務一覧シート]
        InputDate[入力日付]
    end
    
    subgraph ProcessingData[処理中データ]
        CalendarMap[カレンダーマップ]
        TaskData[業務データ配列]
        Headers[ヘッダー情報]
        DateInfo[日付情報]
    end
    
    subgraph OutputData[出力データ]
        ScheduleSheet[業務スケジュールシート]
        TestResults[テスト結果シート]
        DebugLogs[デバッグログシート]
    end
    
    InputData --> ProcessingData
    ProcessingData --> OutputData
    
    Calendar --> CalendarMap
    TaskList --> TaskData
    TaskList --> Headers
    InputDate --> DateInfo
    
    CalendarMap --> isBusinessDay
    DateInfo --> isTargetTask
    TaskData --> isTargetTask
    Headers --> isTargetTask
    
    isTargetTask --> ScheduleSheet
    isTargetTask --> TestResults
    debugLog --> DebugLogs
```

## 3. メイン処理フロー

```mermaid
flowchart TD
    開始([プログラム開始]) --> InitDebug[デバッグログ初期化]
    InitDebug --> LoadCalendar[カレンダー情報の読み込み]
    LoadCalendar --> IsTest{isTest変数の値?}
    IsTest -->|true| RunTests[テスト実行]
    IsTest -->|false| RunSchedule[スケジュール生成]
    RunTests --> End([プログラム終了])
    RunSchedule --> End
```

## 4. デバッグ・テストユーティリティ

```mermaid
flowchart TD
    subgraph DebugUtils[デバッグユーティリティ]
        create_debug_sheet[デバッグシート作成]
        debugLog[デバッグログ記録]
    end
    
    subgraph TestUtils[テストユーティリティ]
        prepareTestSheet[テストシート準備]
        runSingleTest[単一テスト実行]
        runTestSuite[テスト一括実行]
        outputTestResults[テスト結果出力]
        getExpectedTaskIds[期待ID取得]
        getDayOfWeekString[曜日文字列変換]
    end
    
    TestUtils --> DebugUtils
```

## 5. カレンダー情報読み込みフロー

```mermaid
flowchart TD
    Start([カレンダー読み込み開始]) --> GetSheet[カレンダーシート取得]
    GetSheet --> CheckSheet{シートは存在する?}
    CheckSheet -->|No| ThrowError[エラー発生]
    CheckSheet -->|Yes| GetData[カレンダーデータ取得]
    GetData --> CreateMap[CalendarInfoマップ作成]
    
    CreateMap --> ProcessLoop[データ処理開始]
    ProcessLoop --> CheckRow{日付データあり?}
    CheckRow -->|No| NextRow[次の行へ]
    CheckRow -->|Yes| ConvertDate[日付文字列に変換]
    
    ConvertDate --> CheckDateValid{変換成功?}
    CheckDateValid -->|No| NextRow
    CheckDateValid -->|Yes| GetBusinessDay[営業日フラグ取得]
    GetBusinessDay --> AddToMap[マップに追加]
    
    AddToMap --> NextRow
    NextRow --> HasMoreRows{全行処理完了?}
    HasMoreRows -->|No| ProcessLoop
    HasMoreRows -->|Yes| LogCount[データ件数をログ記録]
    LogCount --> ReturnMap[カレンダーマップを返却]
    
    ThrowError --> End([エラー終了])
    ReturnMap --> End2([カレンダー読み込み終了])
```

## 6. 日付・営業日ユーティリティ関数

```mermaid
flowchart LR
    subgraph DateUtils[日付ユーティリティ]
        formatDate[日付→YYYY-MM-DD変換]
        formatDateBySlash[日付→YYYY/MM/DD変換]
        excelDateToString[Excel日付→文字列変換]
        getLastDayOfMonth[月末日取得]
        getDateInfo[日付情報取得]
        getNthDayOfWeekInMonth[第n曜日計算]
    end
    
    subgraph BusinessDayUtils[営業日ユーティリティ]
        isBusinessDay[営業日判定]
        getBusinessDayInfo[営業日情報取得]
        getNthBusinessDayOfMonth[第n営業日取得]
        getReverseNthBusinessDayOfMonth[月末からn営業日前取得]
        getPreviousBusinessDay[直前営業日取得]
        getNextBusinessDay[直後営業日取得]
    end
    
    DateUtils -.-> BusinessDayUtils
```

## 7. 業務判定フロー (isTargetTask関数)

```mermaid
flowchart TD
    Start([業務判定開始]) --> GetTaskId[業務ID取得]
    GetTaskId --> CheckValidity[有効期間チェック]
    CheckValidity --> IsValid{有効期間内?}
    IsValid -->|No| ReturnFalse[対象外: falseを返却]
    IsValid -->|Yes| GetTaskParams[業務パラメータ取得]
    
    GetTaskParams --> GetDateInfo[日付情報取得]
    GetDateInfo --> IsYearly{年次業務?}
    
    IsYearly -->|Yes| CheckMonth{月指定と一致?}
    IsYearly -->|No| GetFreq[周期・頻度判定]
    
    CheckMonth -->|No| ReturnFalse
    CheckMonth -->|Yes| GetFreq
    
    GetFreq --> IsDaily{日次業務?}
    IsDaily -->|Yes| EvalDaily[日次業務判定]
    IsDaily -->|No| IsWeekly{週次業務?}
    
    IsWeekly -->|Yes| EvalWeekly[週次業務判定]
    IsWeekly -->|No| IsMonthly{月次業務?}
    
    IsMonthly -->|Yes| EvalMonthly[月次業務判定]
    IsMonthly -->|No| EvalYearly{年次業務?}
    
    EvalYearly -->|Yes| EvalYearlyTask[年次業務判定]
    EvalYearly -->|No| LogNoMatch[どの条件にも一致せず]
    
    EvalDaily --> ReturnResult[判定結果をログ記録して返却]
    EvalWeekly --> ReturnResult
    EvalMonthly --> ReturnResult
    EvalYearlyTask --> ReturnResult
    LogNoMatch --> ReturnFalse
    
    ReturnFalse --> End([業務判定終了])
    ReturnResult --> End
```

## 8. 月次/年次業務の基準別判定フロー

```mermaid
flowchart TD
    Start([基準別判定開始]) --> GetBase{基準は?}
    
    GetBase -->|"暦日(n日指定)"| CheckCalNth[暦日n日指定判定]
    GetBase -->|"暦日(月末逆算)"| CheckCalEndMonth[暦日月末逆算判定]
    GetBase -->|"営業日(n日指定)"| CheckBizNth[営業日n日指定判定]
    GetBase -->|"営業日(月末逆算)"| CheckBizEndMonth[営業日月末逆算判定]
    GetBase -->|"暦日(曜日)"| CheckCalWeekday[暦日曜日指定判定]
    GetBase -->|その他| ReturnFalse[対象外: falseを返却]
    
    CheckCalNth --> ReturnCalNthResult[暦日n日判定結果]
    CheckCalEndMonth --> ReturnCalEndMonthResult[暦日月末逆算判定結果]
    CheckBizNth --> ReturnBizNthResult[営業日n日判定結果]
    CheckBizEndMonth --> ReturnBizEndMonthResult[営業日月末逆算判定結果]
    CheckCalWeekday --> ReturnCalWeekdayResult[暦日曜日判定結果]
    
    ReturnCalNthResult --> End([基準別判定終了])
    ReturnCalEndMonthResult --> End
    ReturnBizNthResult --> End
    ReturnBizEndMonthResult --> End
    ReturnCalWeekdayResult --> End
    ReturnFalse --> End
```

## 9. 業務判定ユーティリティ関数

```mermaid
flowchart TD
    subgraph TaskJudgementUtils[業務判定ユーティリティ]
        isTargetTask[業務判定メイン]
        isDailyTask[日次業務判定]
        isWeeklyTask[週次業務判定]
        isCalendarDayNthTask[暦日n日指定判定]
        isCalendarDayEndOfMonthTask[暦日月末逆算判定]
        isBusinessDayNthTask[営業日n日指定判定]
        isBusinessDayEndOfMonthTask[営業日月末逆算判定]
        isCalendarDayWeekDayTask[暦日曜日指定判定]
        isTargetDateForFurikae[振替対象日判定]
        isMatchingOriginalCondition[元条件一致判定]
    end
    
    isTargetTask --> isDailyTask
    isTargetTask --> isWeeklyTask
    isTargetTask --> isCalendarDayNthTask
    isTargetTask --> isCalendarDayEndOfMonthTask
    isTargetTask --> isBusinessDayNthTask
    isTargetTask --> isBusinessDayEndOfMonthTask
    isTargetTask --> isCalendarDayWeekDayTask
    
    isTargetDateForFurikae --> isMatchingOriginalCondition
    isCalendarDayNthTask --> applyFurikaeRule[振替規則適用]
    isCalendarDayEndOfMonthTask --> applyFurikaeRule
    isCalendarDayWeekDayTask --> applyFurikaeRule
```

## 10. 業務種別と判定条件の関係

```mermaid
flowchart TD
    subgraph FrequencyTypes[周期・頻度]
        Daily[日次]
        Weekly[週次]
        Monthly[月次]
        Yearly[年次]
    end
    
    subgraph BaseTypes[基準種別]
        CalendarDay[暦日]
        BusinessDay[営業日]
        CalendarDayNth[暦日n日指定]
        CalendarDayEndOfMonth[暦日月末逆算]
        BusinessDayNth[営業日n日指定]
        BusinessDayEndOfMonth[営業日月末逆算]
        CalendarDayWeekDay[暦日曜日指定]
    end

    
    subgraph FurikaeRules[振替規則]
        NoFurikae[振替しない]
        PreviousBizDay[直前営業日]
        NextBizDay[直後営業日]
    end
    
    Daily --> CalendarDay
    Daily --> BusinessDay
    
    Weekly --> CalendarDayWeekDay
    
    Monthly --> CalendarDayNth
    Monthly --> CalendarDayEndOfMonth
    Monthly --> BusinessDayNth
    Monthly --> BusinessDayEndOfMonth
    Monthly --> CalendarDayWeekDay
    
    Yearly --> CalendarDayNth
    Yearly --> CalendarDayEndOfMonth
    Yearly --> BusinessDayNth
    Yearly --> BusinessDayEndOfMonth
    Yearly --> CalendarDayWeekDay
    
    CalendarDayNth --> NoFurikae
    CalendarDayNth --> PreviousBizDay
    CalendarDayNth --> NextBizDay
    
    CalendarDayEndOfMonth --> NoFurikae
    CalendarDayEndOfMonth --> PreviousBizDay
    CalendarDayEndOfMonth --> NextBizDay
    
    CalendarDayWeekDay --> NoFurikae
    CalendarDayWeekDay --> PreviousBizDay
    CalendarDayWeekDay --> NextBizDay
```

## 11. スケジュール生成フロー 

```mermaid
flowchart TD
    Start([スケジュール生成開始]) --> PrepSheet[業務スケジュールシート準備]
    PrepSheet --> GetDate[入力日付を取得]
    GetDate --> DateValid{日付は有効?}
    DateValid -->|No| ThrowError[エラー発生]
    DateValid -->|Yes| ConvertDate[日付形式変換]
    
    ConvertDate --> LogDate[日付をログに記録]
    LogDate --> LoadTasks[業務一覧データを読み込み]
    
    LoadTasks --> ProcessTaskLoop[業務ループ処理開始]
    ProcessTaskLoop --> GetTaskId[業務ID取得]
    
    GetTaskId --> ValidId{業務IDは有効?}
    ValidId -->|No| NextTask[次の業務へ]
    ValidId -->|Yes| EvalTask[業務判定実行]
    
    EvalTask --> IsTarget{対象業務?}
    IsTarget -->|Yes| CountMatch[一致件数増加]
    IsTarget -->|No| CheckFurikae[振替対象日判定]
    
    CountMatch --> AddTask[スケジュールに追加]
    
    CheckFurikae --> IsFurikae{振替対象日?}
    IsFurikae -->|Yes| CountMatch
    IsFurikae -->|No| NextTask
    
    AddTask --> NextTask
    NextTask --> HasMoreTasks{全業務確認完了?}
    HasMoreTasks -->|No| ProcessTaskLoop
    HasMoreTasks -->|Yes| LogResult[処理結果記録]
    LogResult --> End([スケジュール生成終了])
    
    ThrowError --> End2([エラー終了])
```

## 12. 日次業務判定フロー

```mermaid
flowchart TB
    日次開始[日次業務判定開始] --> 基準分岐{基準}
    基準分岐 -->|営業日| 営業日判定{対象日は営業日?}
    営業日判定 -->|YES| 日次実行[実行対象と判定]
    営業日判定 -->|NO| 日次実行対象外[実行対象外と判定]
    基準分岐 -->|暦日| 日次実行[実行対象と判定]
    日次実行 --> 日次終了[日次業務判定終了]
    日次実行対象外 --> 日次終了
```

## 13. 週次業務判定フロー

```mermaid
flowchart TB
     週次開始[週次業務判定開始] --> 基準分岐{基準}
    基準分岐 -->|"暦日(曜日)"| 曜日判定{設定曜日と一致?}
    曜日判定 -->|YES| 週次実行[実行対象と判定]
    曜日判定 -->|NO| 週次実行対象外[実行対象外と判定]
    週次実行 --> 週次終了[週次業務判定終了]
    週次実行対象外 --> 週次終了
```

## 14. 月次業務判定フロー

```mermaid
flowchart TB
    月次開始[月次業務判定開始] --> 基準分岐{基準}

    基準分岐 -->|"暦日(n日指定)"| 日付判定{n日と一致?}
    日付判定 -->|YES| 月次実行[実行対象と判定]
    日付判定 -->|NO| 月次実行対象外[実行対象外と判定]

    基準分岐 -->|"暦日(月末逆算)"| 月末逆算判定{月末からn日前と一致?}
    月末逆算判定 -->|YES| 月次実行
    月末逆算判定 -->|NO| 月次実行対象外

    基準分岐 -->|"営業日(n日指定)"| 営業日判定{n番目の営業日と一致?}
    営業日判定 -->|YES| 月次実行
    営業日判定 -->|NO| 月次実行対象外

    基準分岐 -->|"営業日(月末逆算)"| 営業日月末逆算判定{月末からn営業日前と一致?}
    営業日月末逆算判定 -->|YES| 月次実行
    営業日月末逆算判定 -->|NO| 月次実行対象外

    基準分岐 -->|"暦日(曜日)"| 週番号曜日判定{第n週の指定曜日と一致?}
    週番号曜日判定 -->|YES| 月次実行
    週番号曜日判定 -->|NO| 月次実行対象外

    月次実行 --> 月次終了[月次業務判定終了]
    月次実行対象外 --> 月次終了
```

## 15. 年次業務判定フロー

```mermaid
flowchart TB
    年次開始[年次業務判定開始] --> 月判定{設定月と一致?}
    月判定 -->|YES| 基準分岐{基準}
    月判定 -->|NO| 年次実行対象外[実行対象外と判定]

    基準分岐 -->|"暦日(n日指定)"| 日付判定{n日と一致?}
    日付判定 -->|YES| 年次実行[実行対象と判定]
    日付判定 -->|NO| 年次実行対象外

    基準分岐 -->|"暦日(月末逆算)"| 月末逆算判定{月末からn日前と一致?}
    月末逆算判定 -->|YES| 年次実行
    月末逆算判定 -->|NO| 年次実行対象外

    基準分岐 -->|"営業日(n日指定)"| 営業日判定{n番目の営業日と一致?}
    営業日判定 -->|YES| 年次実行
    営業日判定 -->|NO| 年次実行対象外

    基準分岐 -->|"営業日(月末逆算)"| 営業日月末逆算判定{月末からn営業日前と一致?}
    営業日月末逆算判定 -->|YES| 年次実行
    営業日月末逆算判定 -->|NO| 年次実行対象外

    基準分岐 -->|"暦日(曜日)"| 週番号曜日判定{当月の第n週の指定曜日と一致?}
    週番号曜日判定 -->|YES| 年次実行
    週番号曜日判定 -->|NO| 年次実行対象外

    年次実行 --> 年次終了[年次業務判定終了]
    年次実行対象外 --> 年次終了
```

## 16. 業務振替判定フロー (isTargetDateForFurikae関数)

```mermaid
flowchart TD
    Start([振替判定開始]) --> CheckBizDay{営業日?}
    CheckBizDay -->|No| ReturnFalse[振替対象外: falseを返却]
    CheckBizDay -->|Yes| GetTaskParams[業務パラメータ取得]
    
    GetTaskParams --> CheckRule{振替規則あり?}
    CheckRule -->|No| ReturnFalse
    CheckRule -->|Yes| CheckRuleType{規則の種類?}
    
    CheckRuleType -->|直前営業日| PrevBizDayCheck[前営業日振替チェック]
    CheckRuleType -->|直後営業日| NextBizDayCheck[後営業日振替チェック]
    CheckRuleType -->|その他| ReturnFalse
    
    PrevBizDayCheck --> PrevLoop[翌日からの非営業日を検索]
    PrevLoop --> CheckNextDay{翌日は営業日?}
    CheckNextDay -->|Yes| PrevLoopEnd[検索終了]
    CheckNextDay -->|No| MatchOriginal1[元の条件判定]
    
    MatchOriginal1 --> IsOrigMatch1{条件一致?}
    IsOrigMatch1 -->|No| NextDate1[さらに翌日へ]
    IsOrigMatch1 -->|Yes| CheckPrevDay[この日の直前営業日を取得]
    
    CheckPrevDay --> IsPrevMatch{inputDateと一致?}
    IsPrevMatch -->|Yes| ReturnTrue[振替対象: trueを返却]
    IsPrevMatch -->|No| NextDate1
    
    NextDate1 --> CheckDayLimit1{最大日数超過?}
    CheckDayLimit1 -->|Yes| PrevLoopEnd
    CheckDayLimit1 -->|No| PrevLoop
    
    NextBizDayCheck --> NextLoop[前日からの非営業日を検索]
    NextLoop --> CheckPrevDay2{前日は営業日?}
    CheckPrevDay2 -->|Yes| NextLoopEnd[検索終了]
    CheckPrevDay2 -->|No| MatchOriginal2[元の条件判定]
    
    MatchOriginal2 --> IsOrigMatch2{条件一致?}
    IsOrigMatch2 -->|No| PrevDate2[さらに前日へ]
    IsOrigMatch2 -->|Yes| CheckNextDay2[この日の直後営業日を取得]
    
    CheckNextDay2 --> IsNextMatch{inputDateと一致?}
    IsNextMatch -->|Yes| ReturnTrue
    IsNextMatch -->|No| PrevDate2
    
    PrevDate2 --> CheckDayLimit2{最大日数超過?}
    CheckDayLimit2 -->|Yes| NextLoopEnd
    CheckDayLimit2 -->|No| NextLoop
    
    PrevLoopEnd --> ReturnFalse
    NextLoopEnd --> ReturnFalse
    
    ReturnTrue --> End([振替判定終了])
    ReturnFalse --> End
```

## 17. テスト実行フロー

```mermaid
flowchart TD
    Start([テスト実行開始]) --> LogTestStart[テスト開始をログ記録]
    LogTestStart --> PrepTestSheet[テストシート準備]
    PrepTestSheet --> DefineTestDates[テスト日付定義]
    DefineTestDates --> InitResults[結果配列初期化]
    
    InitResults --> TestLoop[テスト日付ループ]
    TestLoop --> RunTest[単一日付テスト実行]
    RunTest --> StoreResult[結果を配列に格納]
    
    StoreResult --> MoreDates{テスト完了?}
    MoreDates -->|No| TestLoop
    MoreDates -->|Yes| OutputResults[テスト結果をシートに出力]
    
    OutputResults --> CalcSummary[結果サマリー計算]
    CalcSummary --> LogComplete[完了をログ記録]
    LogComplete --> End([テスト実行終了])
```

## 18. 単一日付テスト実行フロー

```mermaid
flowchart TD
    Start([単一日付テスト開始]) --> LogTest[テスト日付をログ記録]
    LogTest --> GetDateInfo[日付情報取得]
    GetDateInfo --> PrepScheduleSheet[スケジュールシート準備]
    
    PrepScheduleSheet --> SetDate[テスト日付をB1セルに設定]
    SetDate --> LoadTaskData[業務一覧データ読み込み]
    
    LoadTaskData --> InitTaskIds[業務ID配列初期化]
    InitTaskIds --> ProcessTaskLoop[業務ループ開始]
    
    ProcessTaskLoop --> GetTaskId[業務ID取得]
    GetTaskId --> ValidId{業務IDは有効?}
    ValidId -->|No| NextTask[次の業務へ]
    ValidId -->|Yes| IsTarget[対象業務判定]
    
    IsTarget --> MatchTask{対象業務?}
    MatchTask -->|Yes| AddTaskId[業務IDを配列に追加]
    MatchTask -->|No| CheckFurikae[振替対象日判定]
    
    CheckFurikae --> IsFurikae{振替対象日?}
    IsFurikae -->|Yes| AddTaskId
    IsFurikae -->|No| NextTask
    
    AddTaskId --> NextTask
    NextTask --> MoreTasks{全業務完了?}
    MoreTasks -->|No| ProcessTaskLoop
    MoreTasks -->|Yes| GetExpected[期待される業務ID取得]
    
    GetExpected --> SortTaskIds[業務IDをソート]
    SortTaskIds --> CompareResults[結果比較]
    CompareResults --> CreateResult[テスト結果オブジェクト作成]
    CreateResult --> ReturnResult[テスト結果返却]
    
    ReturnResult --> End([単一日付テスト終了])
```

## 19. 「n日」カラムの使用方法詳細

```mermaid
flowchart LR
    nDay[n日カラム] --> 基準分岐{基準}
    
    基準分岐 -->|"暦日(n日指定)"| 暦日日指定["n日 = 1~31（カレンダー上の日付）"]
    基準分岐 -->|"営業日(n日指定)"| 営業日日指定["n日 = 1~31（当月n番目の営業日）"]
    
    基準分岐 -->|"暦日(月末逆算)"| 暦日月末指定["n日 = 0（末日）, 1（末日から1日前）, ..."]
    基準分岐 -->|"営業日(月末逆算)"| 営業日月末指定["n日 = 0（最終営業日）, 1（最終営業日から1営業日前）, ..."]
```

## 20. PowerBI連携データフロー

```mermaid
flowchart TB
    subgraph "入力データ"
        カレンダー["カレンダー.csv
        - 年月日
        - 営業日フラグ
        - 曜日
        - 営業日（当月n日目）
        - 逆算営業日（当月末からn日目）"]
        
        業務一覧["業務一覧テーブル
        - 業務ID
        - 業務名
        - 周期・頻度 (日次/週次/月次/年次)
        - 基準 (暦日/営業日)
        - 月/週番号/曜日/n日
        - 非営業日振替規則
        - 有効期間"]
        
        業務スケジュール["業務スケジュールテーブル
        - スケジュールID
        - 業務ID
        - 予定日"]
    end
    
    subgraph "Power Query変換"
        業務マージ["業務+スケジュールマージ"]
        日付マージ["日付情報マージ"]
        メトリクス計算["遅延・進捗メトリクス計算"]
    end
    
    subgraph "Power BIモデル"
        進捗テーブル["進捗管理テーブル"]
        日付テーブル["日付ディメンション"]
        業務テーブル["業務ディメンション"]
        メジャー["DAXメジャー(KPI)"]
    end
    
    subgraph "Power BIビジュアル"
        ガントチャート["ガントチャート"]
        ダッシュボード["ダッシュボード"]
        進捗表["進捗管理表"]
        カレンダービュー["カレンダービュー"]
    end
    
    カレンダー --> 日付マージ
    業務一覧 --> 業務マージ
    業務スケジュール --> 業務マージ
    
    業務マージ --> 日付マージ
    日付マージ --> メトリクス計算
    
    メトリクス計算 --> 進捗テーブル
    メトリクス計算 --> 日付テーブル
    メトリクス計算 --> 業務テーブル
    
    進捗テーブル --> メジャー
    日付テーブル --> メジャー
    業務テーブル --> メジャー
    
    メジャー --> ガントチャート
    メジャー --> ダッシュボード
    メジャー --> 進捗表
    メジャー --> カレンダービュー
```

## 21. テスト計画

システムの品質を確保するため、以下の観点からテストを実施します：

1. **基本機能テスト**：各周期（日次/週次/月次/年次）、各基準（暦日/営業日）の組み合わせが正しく動作するか
2. **境界値テスト**：月初・月末・年始・年末などの境界条件が正しく処理されるか
3. **振替規則テスト**：非営業日振替規則（直前営業日/直後営業日/振替しない）が正しく適用されるか
4. **特殊日テスト**：祝日や特殊な日（2月29日など）の処理が正しく行われるか
5. **連休テスト**：ゴールデンウィークなど連続した休日がある場合の処理が正しく行われるか

特に以下のテストデータが重要です：

- 通常期間テスト（2025-03-24～2025-03-30）
- 月末月初期間テスト（2025-04-28～2025-05-04）
- 連休期間テスト（2025-05-03～2025-05-09）
- 年末年始期間テスト（2024-12-28～2025-01-04）
- 閾値テスト（閏年、月末日など）

これらのテストデータに対して、期待される業務IDとの一致を確認します。

## 22. テスト実施手順

1. scheduler.ostsを開く
2. isTest変数をtrueに設定
3. スクリプトを実行する
4. テストシートに出力された結果を確認する
5. 全てのテストケースで期待される結果と一致することを確認する

## 23. 実運用手順

1. scheduler.ostsをExcelで開く
2. isTest変数をfalseに設定
3. B1セルに対象日付を入力する
4. スクリプトを実行する
5. 業務スケジュールシートに出力された結果を確認する
6. 必要に応じて、この結果をPower BIで可視化・分析する