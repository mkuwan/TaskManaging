# 業務スケジュール管理システム 処理フロー

このドキュメントでは、Office Scripts for Excel向け業務スケジュール管理システム「scheduler.osts」の処理フローを図示します。

## 全体概要

```mermaid
flowchart TD
    Start([プログラム開始]) --> InitDebug[デバッグログ初期化]
    InitDebug --> LoadCalendar[カレンダー情報の読み込み]
    LoadCalendar --> IsTest{isTest変数の値?}
    IsTest -->|true| RunTests[テスト実行]
    IsTest -->|false| RunSchedule[スケジュール生成]
    RunTests --> End([プログラム終了])
    RunSchedule --> End
```

## カレンダー情報読み込みフロー

```mermaid
flowchart TD
    Start([カレンダー読み込み開始]) --> GetSheet[カレンダーシート取得]
    GetSheet --> CheckSheet{シートは存在する?}
    CheckSheet -->|No| ThrowError[エラー発生]
    CheckSheet -->|Yes| GetData[カレンダーデータ取得]
    GetData --> CreateMap[CalendarInfoマップ作成]
    
    CreateMap --> ProcessLoop[データ処理開始]
    ProcessLoop --> CheckRow{日付データあり?}
    CheckRow -->|No| NextRow[次の行へ]
    CheckRow -->|Yes| ConvertDate[日付文字列に変換]
    
    ConvertDate --> CheckDateValid{変換成功?}
    CheckDateValid -->|No| NextRow
    CheckDateValid -->|Yes| GetBusinessDay[営業日フラグ取得]
    GetBusinessDay --> AddToMap[マップに追加]
    
    AddToMap --> NextRow
    NextRow --> HasMoreRows{全行処理完了?}
    HasMoreRows -->|No| ProcessLoop
    HasMoreRows -->|Yes| LogCount[データ件数をログ記録]
    LogCount --> ReturnMap[カレンダーマップを返却]
    
    ThrowError --> End([エラー終了])
    ReturnMap --> End2([カレンダー読み込み終了])
```

## スケジュール生成フロー

```mermaid
flowchart TD
    Start([スケジュール生成開始]) --> PrepSheet[業務スケジュールシート準備]
    PrepSheet --> GetDate[入力日付を取得]
    GetDate --> DateValid{日付は有効?}
    DateValid -->|No| ThrowError[エラー発生]
    DateValid -->|Yes| ConvertDate[日付形式変換]
    
    ConvertDate --> LogDate[日付をログに記録]
    LogDate --> LoadTasks[業務一覧データを読み込み]
    
    LoadTasks --> ProcessTaskLoop[業務ループ処理開始]
    ProcessTaskLoop --> GetTaskId[業務ID取得]
    
    GetTaskId --> ValidId{業務IDは有効?}
    ValidId -->|No| NextTask[次の業務へ]
    ValidId -->|Yes| EvalTask[業務判定実行]
    
    EvalTask --> IsTarget{対象業務?}
    IsTarget -->|Yes| CountMatch[一致件数増加]
    IsTarget -->|No| CheckFurikae[振替対象日判定]
    
    CountMatch --> AddTask[スケジュールに追加]
    
    CheckFurikae --> IsFurikae{振替対象日?}
    IsFurikae -->|Yes| CountMatch
    IsFurikae -->|No| NextTask
    
    AddTask --> NextTask
    NextTask --> HasMoreTasks{全業務確認完了?}
    HasMoreTasks -->|No| ProcessTaskLoop
    HasMoreTasks -->|Yes| LogResult[処理結果記録]
    LogResult --> End([スケジュール生成終了])
    
    ThrowError --> End2([エラー終了])
```

## テスト実行フロー

```mermaid
flowchart TD
    Start([テスト実行開始]) --> LogTestStart[テスト開始をログ記録]
    LogTestStart --> PrepTestSheet[テストシート準備]
    PrepTestSheet --> DefineTestDates[テスト日付定義]
    DefineTestDates --> InitResults[結果配列初期化]
    
    InitResults --> TestLoop[テスト日付ループ]
    TestLoop --> RunTest[単一日付テスト実行]
    RunTest --> StoreResult[結果を配列に格納]
    
    StoreResult --> MoreDates{テスト完了?}
    MoreDates -->|No| TestLoop
    MoreDates -->|Yes| OutputResults[テスト結果をシートに出力]
    
    OutputResults --> CalcSummary[結果サマリー計算]
    CalcSummary --> LogComplete[完了をログ記録]
    LogComplete --> End([テスト実行終了])
```

## 単一日付テスト実行フロー

```mermaid
flowchart TD
    Start([単一日付テスト開始]) --> LogTest[テスト日付をログ記録]
    LogTest --> GetDateInfo[日付情報取得]
    GetDateInfo --> PrepScheduleSheet[スケジュールシート準備]
    
    PrepScheduleSheet --> SetDate[テスト日付をB1セルに設定]
    SetDate --> LoadTaskData[業務一覧データ読み込み]
    
    LoadTaskData --> InitTaskIds[業務ID配列初期化]
    InitTaskIds --> ProcessTaskLoop[業務ループ開始]
    
    ProcessTaskLoop --> GetTaskId[業務ID取得]
    GetTaskId --> ValidId{業務IDは有効?}
    ValidId -->|No| NextTask[次の業務へ]
    ValidId -->|Yes| IsTarget[対象業務判定]
    
    IsTarget --> MatchTask{対象業務?}
    MatchTask -->|Yes| AddTaskId[業務IDを配列に追加]
    MatchTask -->|No| CheckFurikae[振替対象日判定]
    
    CheckFurikae --> IsFurikae{振替対象日?}
    IsFurikae -->|Yes| AddTaskId
    IsFurikae -->|No| NextTask
    
    AddTaskId --> NextTask
    NextTask --> MoreTasks{全業務完了?}
    MoreTasks -->|No| ProcessTaskLoop
    MoreTasks -->|Yes| GetExpected[期待される業務ID取得]
    
    GetExpected --> SortTaskIds[業務IDをソート]
    SortTaskIds --> CompareResults[結果比較]
    CompareResults --> CreateResult[テスト結果オブジェクト作成]
    CreateResult --> ReturnResult[テスト結果返却]
    
    ReturnResult --> End([単一日付テスト終了])
```

## 業務判定フロー (isTargetTask関数)

```mermaid
flowchart TD
    Start([業務判定開始]) --> GetTaskId[業務ID取得]
    GetTaskId --> CheckValidity[有効期間チェック]
    CheckValidity --> IsValid{有効期間内?}
    IsValid -->|No| ReturnFalse[対象外: falseを返却]
    IsValid -->|Yes| GetTaskParams[業務パラメータ取得]
    
    GetTaskParams --> GetDateInfo[日付情報取得]
    GetDateInfo --> IsYearly{年次業務?}
    
    IsYearly -->|Yes| CheckMonth{月指定と一致?}
    IsYearly -->|No| GetFreq[周期・頻度判定]
    
    CheckMonth -->|No| ReturnFalse
    CheckMonth -->|Yes| GetFreq
    
    GetFreq --> IsDaily{日次業務?}
    IsDaily -->|Yes| EvalDaily[日次業務判定]
    IsDaily -->|No| IsWeekly{週次業務?}
    
    IsWeekly -->|Yes| EvalWeekly[週次業務判定]
    IsWeekly -->|No| IsMonthly{月次業務?}
    
    IsMonthly -->|Yes| EvalMonthly[月次業務判定]
    IsMonthly -->|No| EvalYearly{年次業務?}
    
    EvalYearly -->|Yes| EvalYearlyTask[年次業務判定]
    EvalYearly -->|No| LogNoMatch[どの条件にも一致せず]
    
    EvalDaily --> ReturnResult[判定結果をログ記録して返却]
    EvalWeekly --> ReturnResult
    EvalMonthly --> ReturnResult
    EvalYearlyTask --> ReturnResult
    LogNoMatch --> ReturnFalse
    
    ReturnFalse --> End([業務判定終了])
    ReturnResult --> End
```

## 月次/年次業務の基準別判定フロー

```mermaid
flowchart TD
    Start([基準別判定開始]) --> GetBase{基準は?}
    
    GetBase -->|"暦日(n日指定)"| CheckCalNth[暦日n日指定判定]
    GetBase -->|"暦日(月末逆算)"| CheckCalEndMonth[暦日月末逆算判定]
    GetBase -->|"営業日(n日指定)"| CheckBizNth[営業日n日指定判定]
    GetBase -->|"営業日(月末逆算)"| CheckBizEndMonth[営業日月末逆算判定]
    GetBase -->|"暦日(曜日)"| CheckCalWeekday[暦日曜日指定判定]
    GetBase -->|その他| ReturnFalse[対象外: falseを返却]
    
    CheckCalNth --> ReturnCalNthResult[暦日n日判定結果]
    CheckCalEndMonth --> ReturnCalEndMonthResult[暦日月末逆算判定結果]
    CheckBizNth --> ReturnBizNthResult[営業日n日判定結果]
    CheckBizEndMonth --> ReturnBizEndMonthResult[営業日月末逆算判定結果]
    CheckCalWeekday --> ReturnCalWeekdayResult[暦日曜日判定結果]
    
    ReturnCalNthResult --> End([基準別判定終了])
    ReturnCalEndMonthResult --> End
    ReturnBizNthResult --> End
    ReturnBizEndMonthResult --> End
    ReturnCalWeekdayResult --> End
    ReturnFalse --> End
```

## 業務振替判定フロー (isTargetDateForFurikae関数)

```mermaid
flowchart TD
    Start([振替判定開始]) --> CheckBizDay{営業日?}
    CheckBizDay -->|No| ReturnFalse[振替対象外: falseを返却]
    CheckBizDay -->|Yes| GetTaskParams[業務パラメータ取得]
    
    GetTaskParams --> CheckRule{振替規則あり?}
    CheckRule -->|No| ReturnFalse
    CheckRule -->|Yes| CheckRuleType{規則の種類?}
    
    CheckRuleType -->|直前営業日| PrevBizDayCheck[前営業日振替チェック]
    CheckRuleType -->|直後営業日| NextBizDayCheck[後営業日振替チェック]
    CheckRuleType -->|その他| ReturnFalse
    
    PrevBizDayCheck --> PrevLoop[翌日からの非営業日を検索]
    PrevLoop --> CheckNextDay{翌日は営業日?}
    CheckNextDay -->|Yes| PrevLoopEnd[検索終了]
    CheckNextDay -->|No| MatchOriginal1[元の条件判定]
    
    MatchOriginal1 --> IsOrigMatch1{条件一致?}
    IsOrigMatch1 -->|No| NextDate1[さらに翌日へ]
    IsOrigMatch1 -->|Yes| CheckPrevDay[この日の直前営業日を取得]
    
    CheckPrevDay --> IsPrevMatch{inputDateと一致?}
    IsPrevMatch -->|Yes| ReturnTrue[振替対象: trueを返却]
    IsPrevMatch -->|No| NextDate1
    
    NextDate1 --> CheckDayLimit1{最大日数超過?}
    CheckDayLimit1 -->|Yes| PrevLoopEnd
    CheckDayLimit1 -->|No| PrevLoop
    
    NextBizDayCheck --> NextLoop[前日からの非営業日を検索]
    NextLoop --> CheckPrevDay2{前日は営業日?}
    CheckPrevDay2 -->|Yes| NextLoopEnd[検索終了]
    CheckPrevDay2 -->|No| MatchOriginal2[元の条件判定]
    
    MatchOriginal2 --> IsOrigMatch2{条件一致?}
    IsOrigMatch2 -->|No| PrevDate2[さらに前日へ]
    IsOrigMatch2 -->|Yes| CheckNextDay2[この日の直後営業日を取得]
    
    CheckNextDay2 --> IsNextMatch{inputDateと一致?}
    IsNextMatch -->|Yes| ReturnTrue
    IsNextMatch -->|No| PrevDate2
    
    PrevDate2 --> CheckDayLimit2{最大日数超過?}
    CheckDayLimit2 -->|Yes| NextLoopEnd
    CheckDayLimit2 -->|No| NextLoop
    
    PrevLoopEnd --> ReturnFalse
    NextLoopEnd --> ReturnFalse
    
    ReturnTrue --> End([振替判定終了])
    ReturnFalse --> End
```

## 日付・営業日ユーティリティ関数

```mermaid
flowchart LR
    subgraph DateUtils[日付ユーティリティ]
        formatDate[日付→YYYY-MM-DD変換]
        formatDateBySlash[日付→YYYY/MM/DD変換]
        excelDateToString[Excel日付→文字列変換]
        getLastDayOfMonth[月末日取得]
        getDateInfo[日付情報取得]
        getNthDayOfWeekInMonth[第n曜日計算]
    end
    
    subgraph BusinessDayUtils[営業日ユーティリティ]
        isBusinessDay[営業日判定]
        getBusinessDayInfo[営業日情報取得]
        getNthBusinessDayOfMonth[第n営業日取得]
        getReverseNthBusinessDayOfMonth[月末からn営業日前取得]
        getPreviousBusinessDay[直前営業日取得]
        getNextBusinessDay[直後営業日取得]
    end
    
    DateUtils -.-> BusinessDayUtils
```

## 業務判定ユーティリティ関数

```mermaid
flowchart TD
    subgraph TaskJudgementUtils[業務判定ユーティリティ]
        isTargetTask[業務判定メイン]
        isDailyTask[日次業務判定]
        isWeeklyTask[週次業務判定]
        isCalendarDayNthTask[暦日n日指定判定]
        isCalendarDayEndOfMonthTask[暦日月末逆算判定]
        isBusinessDayNthTask[営業日n日指定判定]
        isBusinessDayEndOfMonthTask[営業日月末逆算判定]
        isCalendarDayWeekDayTask[暦日曜日指定判定]
        isTargetDateForFurikae[振替対象日判定]
        isMatchingOriginalCondition[元条件一致判定]
    end
    
    isTargetTask --> isDailyTask
    isTargetTask --> isWeeklyTask
    isTargetTask --> isCalendarDayNthTask
    isTargetTask --> isCalendarDayEndOfMonthTask
    isTargetTask --> isBusinessDayNthTask
    isTargetTask --> isBusinessDayEndOfMonthTask
    isTargetTask --> isCalendarDayWeekDayTask
    
    isTargetDateForFurikae --> isMatchingOriginalCondition
    isCalendarDayNthTask --> applyFurikaeRule[振替規則適用]
    isCalendarDayEndOfMonthTask --> applyFurikaeRule
    isCalendarDayWeekDayTask --> applyFurikaeRule
```

## デバッグ・テストユーティリティ

```mermaid
flowchart TD
    subgraph DebugUtils[デバッグユーティリティ]
        create_debug_sheet[デバッグシート作成]
        debugLog[デバッグログ記録]
    end
    
    subgraph TestUtils[テストユーティリティ]
        prepareTestSheet[テストシート準備]
        runSingleTest[単一テスト実行]
        runTestSuite[テスト一括実行]
        outputTestResults[テスト結果出力]
        getExpectedTaskIds[期待ID取得]
        getDayOfWeekString[曜日文字列変換]
    end
    
    TestUtils --> DebugUtils
```

## データフロー概要

```mermaid
flowchart TD
    subgraph InputData[入力データ]
        Calendar[カレンダーシート]
        TaskList[業務一覧シート]
        InputDate[入力日付]
    end
    
    subgraph ProcessingData[処理中データ]
        CalendarMap[カレンダーマップ]
        TaskData[業務データ配列]
        Headers[ヘッダー情報]
        DateInfo[日付情報]
    end
    
    subgraph OutputData[出力データ]
        ScheduleSheet[業務スケジュールシート]
        TestResults[テスト結果シート]
        DebugLogs[デバッグログシート]
    end
    
    InputData --> ProcessingData
    ProcessingData --> OutputData
    
    Calendar --> CalendarMap
    TaskList --> TaskData
    TaskList --> Headers
    InputDate --> DateInfo
    
    CalendarMap --> isBusinessDay
    DateInfo --> isTargetTask
    TaskData --> isTargetTask
    Headers --> isTargetTask
    
    isTargetTask --> ScheduleSheet
    isTargetTask --> TestResults
    debugLog --> DebugLogs
```

## 業務種別と判定条件の関係

```mermaid
flowchart TD
    subgraph FrequencyTypes[周期・頻度]
        Daily[日次]
        Weekly[週次]
        Monthly[月次]
        Yearly[年次]
    end
    
    subgraph BaseTypes[基準種別]
        CalendarDay[暦日]
        BusinessDay[営業日]
        CalendarDayNth[暦日n日指定]
        CalendarDayEndOfMonth[暦日月末逆算]
        BusinessDayNth[営業日n日指定]
        BusinessDayEndOfMonth[営業日月末逆算]
        CalendarDayWeekDay[暦日曜日指定]
    end
    
    subgraph FurikaeRules[振替規則]
        NoFurikae[振替しない]
        PreviousBizDay[直前営業日]
        NextBizDay[直後営業日]
    end
    
    Daily --> CalendarDay
    Daily --> BusinessDay
    
    Weekly --> CalendarDayWeekDay
    
    Monthly --> CalendarDayNth
    Monthly --> CalendarDayEndOfMonth
    Monthly --> BusinessDayNth
    Monthly --> BusinessDayEndOfMonth
    Monthly --> CalendarDayWeekDay
    
    Yearly --> CalendarDayNth
    Yearly --> CalendarDayEndOfMonth
    Yearly --> BusinessDayNth
    Yearly --> BusinessDayEndOfMonth
    Yearly --> CalendarDayWeekDay
    
    CalendarDayNth --> NoFurikae
    CalendarDayNth --> PreviousBizDay
    CalendarDayNth --> NextBizDay
    
    CalendarDayEndOfMonth --> NoFurikae
    CalendarDayEndOfMonth --> PreviousBizDay
    CalendarDayEndOfMonth --> NextBizDay
    
    CalendarDayWeekDay --> NoFurikae
    CalendarDayWeekDay --> PreviousBizDay
    CalendarDayWeekDay --> NextBizDay
```